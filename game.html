<!DOCTYPE html>
<html lang="en">
    <head>
        <title>3 Man!</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.min.css">
        <style>
            button:disabled {
                display: none;
            }
            .dice-box{
                height: 10vh;
                border: 2px dotted #202b38;
                border-radius: 15px;
                padding-top: 1vh;
                width: 100%;
                display: flex;
                justify-content: center;
                align-items: flex-start;
            }

            .dice-box img {
                width: 2vw;
            }

            .die{
                width: 10vw;
            }

            .die-label {
                width: 5vw;
                display: inline;
                margin-right: 2vw;

            }

            .flex-container {
                display: flex;
                flex-direction: column;
            }

            img + .die-label {
                margin-left: 5vw;
            }

            #doubles-roll-btn {
                background-color: rgb(187, 8, 187);
                width: 20vw;
                padding: 15px;
                margin: 10px auto;
                border: 3px solid gray;
                border-radius: 20px;
            }

            .hat {
                width: 3vw;
                margin-left: 1vw;
            }

            #message-box{
                xheight: 10vh;
                xbackground-color: gray;
                text-align: center;
                font-weight: bold;
                font-size: x-large;
                margin-bottom: 5px;

            }

            .player {
                border: 1px solid gray;
                border-radius: 10px;
                padding: 10px;
                color: #202b38;

            }

            .player-pool {
                display: flex;
                justify-content: space-around;
            }

            #roll-btn {
                color: #202b38;
                background-color: rgb(214, 214, 0);
                width: 20vw;
                padding: 15px;
                margin: 10px auto;
                border: 3px solid gray;
                border-radius: 20px;
            }

            #table{
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: rgb(37, 16, 16);
                width: 50vw;
                height: 30vh;
                margin: auto;
                border: 3px solid rgb(37, 16, 16);
                border-radius: 20px;
            }

            .ui-draggable-dragging {
                width: 2vw;
            }

            .ui-droppable-active {
                border: 2px dotted gray;
            }

        </style>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="static/jquery.ui.touch-punch.min.js"></script>
        <script src="/static/classes.js"></script>
        <script type=module>

            $(document).ready(function(){
                var socket = io();
                // temp index into games array
                var game = 1;
                var name = `pl1${Math.floor((Math.random() * 100))}`;
                $('#roll-btn').hide();
                $('#doubles-roll-btn').hide();

                socket.emit('new player', {name: name, gameID: game});
            

                const rollEvent = new Event('rolled');
                const turnComplete = new Event('turnComplete');
                const tableEmptyEvent = new Event('tableEmpty');
                console.log(tableEmptyEvent);

                let playersInGame;
                let currentGame;
                let cont = 0;
                let targets = [];
                let doublesRollNum = 0;

                // make / roll dice
                let dice = new Dice(2,6);
                let roll;
                let doubles = false;
                $('#roll-btn').click(() => {
                    roll = dice.roll();
                    socket.emit('roll', {roll: roll, gameID: game});
                    checkDice(roll);

                    console.log(doubles);
                    console.log(cont);
                    if (cont === 0 & !doubles){
                        socket.emit('turn complete', {gameID: game});
                    }

                    console.log('end of roll.click()');
                    
                });


                socket.on(`state${game}`, function(games) {

                    // update player pool view
                    currentGame = new Game(games); 
                    let players = PlayerPool.PlayerPool(currentGame);

                    if (!players.equals(playersInGame)){
                        $('.player-pool').html("");
                        players.list.forEach((player) => {
                            $('.player-pool').append(`<div id="${player.__id}-container"><div class="player" id="${player.__id}">${player.__name}</div><div class="dice-box" id="${player.__id}-box"></div></div>`);
                            $('.dice-box').droppable({
                                drop: function(event, ui){
                                    console.log('.dice-box.drop()');
                                    console.log(event);
                                    console.log(event.originalEvent);
                                    console.log(ui);
                                    targets.push(`#${event.target.id}`);

                                    $(`#${event.target.id}`).append($(`#${event.originalEvent.target.id}`));  

                                    $(`#${event.originalEvent.target.id}`).css('position', '');
                                    $(`#${event.originalEvent.target.id}`).css('left', '');
                                    $(`#${event.originalEvent.target.id}`).css('top', '');
                                    
                                    console.log(targets);

                                    console.log($('#table').children().length);
                                    if ($('#table').children().length === 0){
                                        // table is empty - let players roll
                                        console.log('table empty');
                                        socket.emit('dice distributed', {gameID: game, locs: targets});
                                        targets = [];
                                        
                                    }
                                }

                                
                            });
                        });

                        // add 3 man hat
                        $(`#${players.threeMan.id}`).append('<img class="hat" src="/assets/PinClipart.com_jester-clipart_195101.png">');
                        
                    }
                    
                    playersInGame = players;

                    // highlight current player
                    $('.player').css('background-color', 'white');
                    $(`#${playersInGame.currentPlayer.id}`).css('background-color', '#ffff66');
                                  
                });

                socket.on(`start turn${game}`, function(player){
                    console.log('socket.on(start turn)');
                    console.log(player.player);
                    cont = 0;
                    if (player.id === socket.id || player.player.__id === socket.id){
                        $('#roll-btn').show();
                    
                    }
                });

                //someone rolled
                socket.on(`roll${game}`, function(roll){
                    console.log('socket.on(roll)');
                    console.log(roll);
                    $('#message-box').text(' ');
                    clearTable();
                    displayDice(roll.roll);
                });

                socket.on(`drink${game}`, function(data){
                    console.log('socket.on(drink)');
                    $(`#${data.id}`).css('background-color', 'green');
                    $('#message-box').text(`${data.name} Drinks!`);
                });

                socket.on(`new three man${game}`, function(data){
                    console.log('socket.on(new three man)');
                    $('.hat').remove();
                    console.log(data);
                    console.log(data.new3Man.__id);
                    $(`#${data.new3Man.__id}`).append('<img class="hat" src="/assets/PinClipart.com_jester-clipart_195101.png">');
                    

                });

                socket.on(`doubles${game}`, function(data){
                    console.log(doublesRollNum);
                    console.log('socket.on(doubles)');
                    // set dice draggable to true let player drag copy of dice to boxes
                    if (playersInGame.currentPlayer.id == socket.id){
                        $('.die').draggable("option", "disabled", false);
                        console.log($('#roll-btn'));
                        $('#roll-btn').hide();  // this is being undone by the state update

                    }
                    $('#message-box').text('Doubles!');
                    doublesRollNum+=1;

                });

                socket.on(`look for dice${game}`, function(rtnData){
                    console.log('socket.on(look for dice)');
                    console.log(rtnData);
                    console.log(rtnData.data.rtnRoll);
                    console.log(doublesRollNum);
                    $('.die-label').remove();
                    if (doublesRollNum % 2 === 1){
                        // if distributed by current player
                        for (let i=0; i<rtnData.data.locs.length; i++){
                            console.log(i);
                            console.log(`${rtnData.data.locs[i]}`);
                            console.log(`#die${i+1}`);
                            
                            $(`${rtnData.data.locs[i]}`).append($(`#die${i+1}`)); 
                        }
                    } else {
                        ;
                    }

                    if ($(`#${socket.id}-box`).children().length > 0){
                        $('#doubles-roll-btn').show(); 
                    }

                });

                $('#doubles-roll-btn').click(() => {
                    console.log('#doubles-roll-btn.click()');
                        $('#doubles-roll-btn').hide();
                        let doublesDice = new Dice($(`#${socket.id}-box`).children().length,6);
                        let roll = doublesDice.roll();
                        //let roll = [3,3];
                        console.log(roll);
                        
                        if (doublesRollNum % 2 === 0) {
                            console.log('original player re-roll');
                            socket.emit('dice returned roll', {roll: roll, gameID: game, name: name});
                            // for testing only
                            //socket.emit('dice returned roll', {roll: [3], gameID: game, name: name});
                            //socket.emit('dice returned roll', {roll: [3], gameID: game, name: name});
                        } else {
                            console.log('line 287 - another doubles roll');
                            socket.emit('doubles roll', {roll: roll, gameID: game, name: name});
                        }

                    });

                socket.on(`doubles roll finished${game}`, function(roll){
                    console.log('socket.on(doubles roll finished)');
                    console.log(roll);
                    $('#message-box').text(' ');
                    clearTable();
                    displayDice(roll.roll, roll.names);

                    if (roll.roll[0] === roll.roll[1]){  // also change this if more dice can be used
                        // current player rolls again - if doubles again, 
                        
                        console.log(roll.roll);
                        //console.log(roll.roll[1]);
                        console.log(playersInGame.currentPlayer.id);
                        console.log(roll);
                        console.log(roll.rtnRoll);
                        console.log(doublesRollNum);
                        if (doublesRollNum % 2 === 0){
                            console.log('safe!');
                            if (playersInGame.currentPlayer.id == socket.id){
                                $('.die').draggable("option", "disabled", false);
                                $('#doubles-roll-btn').hide();
                            }

                        } else {
                            setTimeout(function(){//place dice back in current player box 
                                $(`#${playersInGame.currentPlayer.id}-box`).append($(`#die1`)); 
                                $(`#${playersInGame.currentPlayer.id}-box`).append($(`#die2`)); 
                                $('.die-label').remove();

                                if(playersInGame.currentPlayer.id === socket.id){
                                    $('#doubles-roll-btn').show();
                                }
                            }, 1500);
                        }
                        
                    } 
                    else {
                        console.log(cont);
                        $('#message-box').text(`Drink!`);
                        if(playersInGame.currentPlayer.id === socket.id){
                            //console.log('continue!');
                            $('#roll-btn').show();
                            doubles = false;
                        }
                    }

                    doublesRollNum += 1;

                });

                $(document).on('mousedown', 'img', function(){
                    $('.die-label').remove();
                });
 

                function checkDice(roll) { 
                    if (dice.rollTotal === 7){
                        console.log(7);
                        // tell the server that someone has to drink
                        socket.emit('ahead', {gameID: game});
                        cont += 1;
                    }

                    if (dice.rollTotal === 11){
                        console.log(11);
                        socket.emit('behind', {gameID: game});
                        cont += 1;
                    }

                    if (dice.rollTotal === 3){
                        console.log(3);
                        socket.emit('three man the hard way', {gameID: game, id: socket.id});
                        console.log('end of dice.rollTotal === 3');
                    }

                    if (roll.includes(3)){
                        console.log('3 on a die');
                        socket.emit('three man', {gameID: game});
                        cont += 1;
                    }

                    // test for doubles - needs to change if more dice are allowed
                    if (roll[0] === roll[1]){
                        doubles=true;
                        cont += 1;
                        console.log('doubles');
                        socket.emit('doubles', {gameID: game});
                        
                    }
                    
                    if (dice.rollTotal !== 7 & dice.rollTotal !== 11 & !roll.includes(3) & roll[0] !== roll[1]){
                        cont = 0;
                        $('#roll-btn').hide();
                    }

                    console.log(`cont: ${cont}`);
                };

                // leave the game on disconnect
                $(window).on('unload', (event) => {
                    socket.emit('remove player', {gameID: game, id: socket.id});
                    socket.close();
                });


            });

            function displayDice(dice, diceText){
                    let i = 1;
                    dice.forEach((die) => {
                        if (diceText){
                            console.log('check worked');
                            console.log(`#die${i}`);
                            console.log(diceText);
                            console.log(`${diceText[i-1]}`);
                            $(`#table`).append(`<p class="die-label">${diceText[i-1]}</p>`);
                        }
                        $('#table').append(`<img src="./assets/${die}.png" class="die" id="die${i}">`);  
                        $('.die').draggable({
                            revert: 'invalid',
                            cursorAt: {top: 0, left: 0},
                            disabled: true
                        });
                        
                        i = i+1;
                    });
                }

            function clearTable(){
                $('.die').remove();
                $('.die-label').remove();
            }




        </script>
        <meta charset="utf-8">
    </head>

    <body>
        <h1>3 Man!</h1>
        <div class="flex-container">
            <div>
                <h2>Players</h2>
                <div class="player-pool" id="player-pool"></div>
            </div>
            <button id="roll-btn">Roll</button>
            <button id="doubles-roll-btn">Roll</button>
            <div id="message-box"></div>
            <div id='table'></div>
        </div>

    </body>

</html>