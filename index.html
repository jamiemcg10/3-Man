<!DOCTYPE html>
<html lang="en">
    <head>
        <title>3 Man!</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="3 Man drinking game brought to the internet. Play with your friends in a private session."> 
        <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.min.css">
        
        
        <style>
            .code {
                font-size: 15vh;
                text-align: center;
                font-weight: 900;
                color: yellow;
            }

            details {
                position: absolute;
                bottom: 3vh;
            }


            details > summary {
                font-size: 2.5vh;
            }

            details li {
                font-size: 2vh;
            }

            details > ul {
                margin-top: 0;
                margin-bottom: 0;
            }

            .flex-container {
                display: flex;
                flex-direction: column;
                width: fit-content;
                max-width: max-content;
                margin: auto;
            }

            .flex-container button {
                width: 100%;
                font-weight: bold;
            }

            .game-rules{
                position: absolute;
                bottom: initial;
                margin-top: 2vh;
            }

            h1 {
                
                margin-top: 15vh;
                text-align: center;
                font-size: 5.5vh;
            }

            input {
                margin-right: 0px;
            }

            #play{
                margin-top: 5vh;
                margin-right: 0px;
                width: initial;
                align-self: center;

                height: 6vh;
                font-size: 2vh;
                padding-bottom: 5vh;
                padding-top: 2vh;
            }
            .player-pool {
                display: flex;
                margin-top: 5vh;
                max-width: 60vw;
            }

            .player-pool:first-child{
                margin-left: 0px;
            }

            button:disabled {
                display: none;
            }

            .player-container {
                margin-right: 7.5px;
                margin-left: 7.5px;
            }

            .dice-box{
                margin: .5px;
                height: 5vh;
                border: 2px dotted #202b38;
                border-radius: 15px;
                padding-top: 1vh;
                width: 100%;
                display: flex;
                justify-content: center;
                align-items: flex-start;
            }

            .dice-box img {
                width: 1vw;
                border-radius: 3px;
                margin-right: 1px;
                margin-left: 1px;
            }

            .die{
                width: 5vw;
                background-color: white;
                border: 2px solid black;
                border-radius: 10px;
                margin-right: 5px;
                margin-left: 5px;
            }

            .die-label {
                width: 5vw;
                display: inline;
                margin-right: 2vw;
                xoverflow-wrap: anywhere;
                text-align: right;
                position: absolute;
            }

            .flex-container {
                display: flex;
                flex-direction: column;
            }

            .game-title{
                margin-top: 0vh;
            }

            img + .die-label {
                margin-left: 5vw;
            }

            #doubles-roll-btn {
                background-color: rgb(187, 8, 187);
                width: 20vw;
                padding: 15px;
                margin: 10px auto;
                border: 3px solid gray;
                border-radius: 20px;
            }

            .hat {
                height: 3vh;              
                margin-left: .5vw;
                margin-right: .5vw;
            }

            #message-box{
                text-align: center;
                font-weight: bold;
                font-size: x-large;
                margin-bottom: 5px;

            }

            .player {
                border: 1px solid gray;
                border-radius: 10px;
                padding: 10px;
                color: #202b38;
                background-color: white;
                white-space: nowrap;

            }

            .player-pool {
                display: flex;
                justify-content: space-around;
                flex-wrap: wrap;
            }

            #roll-btn {
                color: #202b38;
                background-color: rgb(214, 214, 0);
                width: 20vw;
                padding: 15px;
                margin: 10px auto;
                border: 3px solid gray;
                border-radius: 20px;
            }

            #room-code{
                color: yellow;
                font-weight: bold;
            }

            #table{
                xdisplay: flex;
                position: relative;
                align-items: center;
                justify-content: center;
                background-color: rgb(41, 23, 17);
                width: 50vw;
                height: 30vh;
                border: 3px solid rgb(41, 23, 17);
                border-radius: 5px;
                align-self: center;
            }

            .ui-draggable-dragging {
                width: 2vw;
                border-radius: 3px;
            }

            .ui-droppable-active {
                border: 2px dotted gray;
            }

            @media only screen and (max-width: 320px) {
                /**/
                details {
                    bottom: initial;
                }
            }

            @media only screen and (max-height: 385px) {
                /**/
                details {
                    bottom: initial;
                }
            }

            @media only screen and (max-width: 550px) {
                .die {
                    border-radius: 5px;
                    width: 7vw;
                }

                .die-label {
                    font-size: x-small;
                    margin-right: 0vw;
                    width: 11vw;
                }

                h1 {
                    margin-top: 20vh;
                }

                .hat {
                    height: 2vh;
                }

                .dice-box{
                    height: 3vh;
                }

                #play {
                    margin-top: 2vh;
                }

                .player {
                    font-size: x-small;
                    padding: 7px;
                }
                #roll-btn {
                    width: 35vw;
                }

                #table {
                    width: 75vw;
                    height: 25vh;
                }
            }

</style>
        
        <link rel="icon" href="/assets/dice-favicon.png">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="/static/classes.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <script src="static/jquery.ui.touch-punch.min.js"></script>
        <script>
            let houseRules = '<details><summary>House Rules</summary>' +
                                                    '<ul><li>Roll a 7, the player ahead of/after you drinks</li>' + 
                                                         '<li>Roll an 11, the player behind/before you drinks</li>' + 
                                                         '<li>Roll a 3 on either die, the 3 man drinks</li>' + 
                                                         '<li>Become the 3 man if you roll a 3 (1 + 2)</li>' + 
                                                         '<li>Create a new rule if you make someone drink for 5 rolls in a row</li></ul>' + 
                                                    '</details>';

            $(document).ready(() => {
                // for testing
                document.onmousemove = function(e){
                var x = e.pageX;
                var y = e.pageY;
                e.target.title = "x: "+x+" y: "+y;
                };
                
                var socket = io({reconnection: false});
                var id = socket.id;
                let inWaitingRoom = false;
                let inGame = false;
                let game;
                let code;
                let name;
                let playersInGame;
                let loaded = false;
                

                $('#start').click(() => {
                    if ($('#name').val() === ""){
                        return false;
                    }
                    id = socket.id;
                    name = $('#name').val();
                    //$('div').remove();
                    $('.flex-container').children().remove();
                    socket.binary(false).emit('get code', socket.id);
                    console.log(socket.id);
                    console.log(id);
                    console.log(`code${id}`);
                });

                socket.on('game code', function(data){
                    if (data.id === id){
                        console.log(data);
                        //let code = data.code;
                        code = data.code;
                        //let game = String(code)[0];
                        game = String(code)[0];
                        console.log(code);
                        console.log(data.code);

                        // enter waiting room here - need to continue to display code somehow
                        socket.binary(false).emit('add to waiting room', {code: data.code, gameID: game, id: id, name: name});
                        inWaitingRoom = true;
                        
                        displayWaitingRoom(game);

                    }
                    
                });



                $('#join').click(() => {
                    if ($('#name').val() === ""){
                        return false;
                    }
                    if ($('#code').val() === ""){
                        $('.warning').remove();
                        $('.flex-container').append('<div class="warning">Please enter a code.</div>')
                        return false;
                    }
                    console.log($('#code').val());
                    id = socket.id;
                    //let code = $('#code').val();
                    code = $('#code').val();
                    game = String(code)[0];
                    name = $('#name').val();
                    console.log(code);
                    socket.binary(false).emit('validate code', {code: code, requestingID: id});
    

                    socket.on(`validated code${code}`, function(code){
                        console.log(code);
                        if (code.valid & code.requestingID === id){
                            console.log('code is valid');
                            console.log(code.gameInProgress);
                            console.log(code.playersAlreadyInRoom);
                            if (!code.gameInProgress){ // game hasn't started
                                $('.flex-container').children().remove();
                                socket.binary(false).emit('add to waiting room', {code: code, gameID: game, id: id, name: name});
                                inWaitingRoom = true;
                                console.log(game);
                                displayWaitingRoom(game, code.playersAlreadyInRoom);
                            } else { // game has started
                                socket.binary(false).emit('new player', {name: name, id: socket.id, gameID: game});
                                renderGamePage();
                                //can this be the actual roll?
                                //displayDice([6,6],[[0.25,0.75],[0.9,0.1]],[0.5,0.5]);
                                inGame = true;
                                socket.binary(false).emit('get game data', {gameID: game});
                                let gameData;
                                socket.on(`game data sent${game}`, function(data){
                                    console.log(loaded);
                                    if (loaded === false){
                                        loaded = true;
                                        console.log(data.gameData.__lastRoll.roll);
                                        if (data.gameData.__lastRoll.roll.length > 0){
                                            console.log('not empty');
                                            displayDice(data.gameData.__lastRoll.roll,[data.gameData.__lastRoll.topPositions,data.gameData.__lastRoll.leftPositions],data.gameData.__lastRoll.rotations);
                                        } else {
                                            console.log('empty');
                                            displayDice([6,6],[[0.25,0.75],[0.9,0.1]],[0.5,0.5]);
                                            debugger;
                                        }
                                        console.log(data);
                                        gameData = data.gameData;
                                        console.log(gameData);
                                        playGame(game, data, true);
                                    }
                                });
                                
                            }
                        }
                        else if (code.requestingID === id) {
                            $('.warning').remove();
                            $('.flex-container').append('<div class="warning">The code you entered is invalid.</div>')

                        }

                    });
                });



            
                function displayWaitingRoom(roomNo, playersInRoom){
                    console.log('in displayRoom(roomNo)');
                    $('.flex-container').append(`<div class="code">${code}</div>`);
                    $('.flex-container').append('<div class="player-pool"></div>');
                    $('.flex-container').append('<button id="play">Play!</button>');
                    $('#play').css("width", "initial");

                    if (playersInRoom){
                        playersInRoom.forEach((player) => {
                            $('.player-pool').append(`<div class="player-container" id="${player.__id}-container"><div class="player" id="${player.__id}">${player.__name}</div><div class="dice-box" id="${player.__id}-box"></div></div>`);

                        });


                    }

                    $('body').append(houseRules);   

                    $('details').on('toggle', (event) => {
                        console.log(event);
                        console.log(event.target.clientHeight);
                    });
                    console.log('changes registering');

                    $('#play').click(() => {
                        console.log('#play.click()');
                        // transition to main page
                        socket.binary(false).emit('start game', {gameID: game});


                    });

                    socket.on(`go to game page${game}`, (gameData)=>{
                        console.log('going to game');
                        console.log(gameData);
                        inWaitingRoom = false;
                        renderGamePage();
                        displayDice([6,6],[[0.25,0.75],[0.9,0.1]],[0.5,0.5]);
                        inGame = true;
                        playGame(game, gameData, false);
 
                    });

                    socket.on(`add to waiting room${game}`, function(player) {
                        $('.player-pool').append(`<div class="player-container" id="${player.id}-container"><div class="player" id="${player.id}">${player.name}</div><div class="dice-box" id="${player.id}-box"></div></div>`);
                    });

                    socket.on(`remove player${game}`, function(data) {
                        console.log('removing in remove player');
                        console.log(`.${data.id}-container`);
                        $(`#${data.id}-container`).remove();
                        
                        console.log(typeof players);
                        if (typeof players !== 'undefined'){
                            // remove from player pool if in game
                            console.log(typeof players);
                            players.removePlayer(data.id);
                        }
                    });

                    // leave the game on disconnect
                    $(window).on('unload', (event) => {
                        console.log("unloading1");
                        socket.binary(false).emit('remove player', {gameID: roomNo, id: socket.id, code: code, removeID: 1});
                        socket.close();
                    });
                    //return null;
                }


                function renderGamePage(){
                    $('body').children().remove();
                    $('body').append(`<p id="room-code">Room code: ${code}</p>`)
                    $('body').append('<h1 class="game-title">3 Man!</h1>');
                    $('body').append('<div class="flex-container"></div>');
                    $('.flex-container').append($('div')).append('<h2>Players</h2><div class="player-pool" id="player-pool"></div>');
                    $('.flex-container').append('<button id="roll-btn">Roll</button>');
                    $('.flex-container').append('<button id="doubles-roll-btn">Roll</button>');
                    $('.flex-container').append('<div id="message-box"></div>');
                    $('.flex-container').append('<div id="table"></div>');
                    $('body').append(houseRules);
                    $('details').addClass('game-rules');   

                }
                
                function playGame(game, gameData, joiningLate){
                    $('#roll-btn').hide();
                    $('#doubles-roll-btn').hide();

                    console.log(gameData);
                    let currentGame = new Game(gameData.gameData);
                    console.log(currentGame);
                    let players = PlayerPool.PlayerPool(currentGame);
                    console.log(players);
                    let cont = 0;
                    let targets = [];
                    let ids = [];
                    let doublesRollNum = 0;
                    let hasJoinedLate;
                    let drinkIndicator;

                    players.list.forEach((player) => {
                        $('.player-pool').append(`<div class="player-container" id="${player.__id}-container"><div class="player" id="${player.__id}">${player.__name}</div><div class="dice-box" id="${player.__id}-box"></div></div>`);
                        $('.dice-box').droppable({
                            drop: function(event, ui){
                                console.log('.dice-box.drop()');
                                console.log(event);
                                console.log(event.originalEvent);
                                console.log(ui);
                                targets.push(`#${event.target.id}`);
                                ids.push(`#${ui.draggable[0].id}`);
                                console.log(`#${event.target.id}`);
                                console.log(`#${event.originalEvent.target.id}`);
                                console.log(ui.draggable[0].id);


                                $(`#${event.target.id}`).append($(`#${ui.draggable[0].id}`));  

                                $(`#${ui.draggable[0].id}`).css('position', '');
                                $(`#${ui.draggable[0].id}`).css('left', '');
                                $(`#${ui.draggable[0].id}`).css('top', '');
                                
                                console.log(targets);

                                console.log($('#table').children().length);
                                if ($('#table').children().length === 0){
                                    // table is empty - let players roll
                                    console.log('table empty');
                                    socket.binary(false).emit('dice distributed', {gameID: game, locs: targets, dice: ids});
                                    targets = [];
                                    ids = [];
                                    
                                }
                            }

                            
                        });

                        // highlight current player
                        console.log(player.id);
                        console.log(players.currentPlayer.id);
                        if (player.__id === players.currentPlayer.id){
                            console.log('match');
                            console.log(`#${player.__id}`);
                            $(`#${player.__id}`).css('background-color', '#ffff66');
                        }
                    });

                    // add 3 man hat
                    $(`#${players.threeMan.id}`).append('<img class="hat" src="/assets/PinClipart.com_jester-clipart_195101.png">');


                    // make / roll dice
                    let dice = new Dice(2,6);
                    let roll;
                    let doubles = false;
                    
                    showMessage('clear');

                    if (joiningLate){
                         hasJoinedLate = true;
                    } 

                    if (hasJoinedLate){
                            socket.binary(false).emit('three man the hard way', {gameID: game});
                            hasJoinedLate = false;
                        }

                    $('#roll-btn').click(() => {
                        console.log(`current table position:`);
                        console.log($('#table').offset());
                        roll = dice.roll();
                        console.log($('#table').offset());
                        socket.binary(false).emit('roll', {roll: roll, gameID: game});
                        console.log($('#table').offset());
                        checkDice(roll);

                        console.log(doubles);
                        console.log(cont);
                        if (cont === 0 & !doubles){
                            socket.binary(false).emit('turn complete', {gameID: game});
                            
                        }

                        console.log('end of roll.click()');
                    
                    });

                    socket.on(`new player${game}`, function(player){
                            // add to player pool copy as well?
                            console.log(player);
                            players.addPlayer(new Player(player.name, player.id));
                            $('.player-pool').append(`<div class="player-container" id="${player.id}-container"><div class="player" id="${player.id}">${player.name}</div><div class="dice-box" id="${player.id}-box"></div></div>`);
                            $('.dice-box').droppable({
                            drop: function(event, ui){
                                console.log('.dice-box.drop()');
                                console.log(event);
                                console.log(event.originalEvent);
                                console.log(ui);
                                // console.log(event.target.id);
                                // console.log(event.originalEvent.target.id);
                                // //targets.push(`#${event.target.id}`);
                                // targets.push(`#${event.originalEvent.target.id}`);

                                targets.push(`#${event.target.id}`);
                                ids.push(`#${ui.draggable[0].id}`);
                                console.log(`#${event.target.id}`);
                                console.log(`#${event.originalEvent.target.id}`);
                                console.log(ui.draggable[0].id);

                                $(`#${event.target.id}`).append($(`#${ui.draggable[0].id}`));  

                                // $(`#${event.originalEvent.target.id}`).css('position', '');
                                // $(`#${event.originalEvent.target.id}`).css('left', '');
                                // $(`#${event.originalEvent.target.id}`).css('top', '');                   

                                $(`#${ui.draggable[0].id}`).css('position', '');
                                $(`#${ui.draggable[0].id}`).css('left', '');
                                $(`#${ui.draggable[0].id}`).css('top', '');
                                
                                console.log(targets);

                                console.log($('#table').children().length);
                                if ($('#table').children().length === 0){
                                    // table is empty - let players roll
                                    console.log('table empty');
                                    socket.binary(false).emit('dice distributed', {gameID: game, locs: targets, dice: ids});
                                    targets = [];
                                    ids = [];
                                    
                                }
                            }

                            
                        });
                    });



                    socket.on(`end of turn${game}`, function(player){
                        console.log(`#${players.currentPlayer.id}`);
                        $(`.player`).css('background-color', 'white');
                        players.nextPlayer();
                    });

                    socket.on(`start turn${game}`, function(player){
                        
                        console.log('socket.on(start turn)');
                        console.log(player);
                        console.log(player.player);
                        //cancel timeout if it exists
                        if (drinkIndicator){
                            window.clearTimeout(drinkIndicator);
                        }

                        // highlight current player
                        $(`.player`).css('background-color', 'white');
                        $(`#${player.__id}`).css('background-color', '#ffff66');

                        if (typeof player.player !== 'undefined'){
                            $(`#${player.player.__id}`).css('background-color', '#ffff66');
                        }

                        cont = 0;
                        doublesRollNum = 0;
                        if (player.id === socket.id || (player.player !== undefined && player.player.__id === socket.id)){

                            $('#roll-btn').show();
                        
                        }
                    });

                    //someone rolled
                    socket.on(`roll${game}`, function(roll){
                        console.log('socket.on(roll)');
                        console.log(roll);
                        //$('#message-box').text(' ');
                        clearTable();
                        console.log($('#table').offset());
                        displayDice(roll.roll, [roll.topPositions, roll.leftPositions], roll.rotations); 
                        showMessage('clear');
                    });

                    socket.on(`drink${game}`, function(data){
                        console.log('socket.on(drink)');
                        console.log(data);
                        let originalColor = $(`#${data.id}`).css('background-color');
                        console.log(originalColor);
                        // fix original Color if still green from previous roll
                        if (originalColor === 'rgb(0, 128, 0)'){
                            if (data.id === players.currentPlayer.id){
                                originalColor = '#ffff66';
                            } else {
                                originalColor = 'white';
                            }

                        }
                        console.log(originalColor);
                        $(`#${data.id}`).css('background-color', 'green');
                        drinkIndicator = window.setTimeout(function() {
                            $(`#${data.id}`).css('background-color', originalColor);
                        }, 1500);
                        //$('#message-box').append(`${data.name} Drinks!<br/>`);
                        showMessage('add', `${data.name} Drinks!<br/>`);
                    });

                    socket.on(`new three man${game}`, function(data){
                        console.log('socket.on(new three man)');
                        $('.hat').remove();
                        console.log(data);
                        console.log(data.new3Man.__id);
                        $(`#${data.new3Man.__id}`).append('<img class="hat" src="/assets/PinClipart.com_jester-clipart_195101.png">');
                        //$('#message-box').append(`${data.new3Man.__name} is the new 3 Man!<br/>`);
                        showMessage('clear'); // not sure if this is needed, but 2 3 man messages shouldn't show at the same time
                        showMessage('add', `${data.new3Man.__name} is the new 3 Man!<br/>`);
                    });

                    socket.on(`doubles${game}`, function(data){
                        console.log(doublesRollNum);
                        console.log('socket.on(doubles)');
                        // set dice draggable to true let player drag copy of dice to boxes
                        // fix so you can't give yourself dice
                        console.log(players.currentPlayer.id);
                        console.log(socket.id);
                        if (players.currentPlayer.id == socket.id){
                            $('.die').draggable("option", "disabled", false);
                            console.log($('#roll-btn'));
                            $('#roll-btn').hide();  // this is being undone by the state update

                        }
                        showMessage('add', 'Doubles!<br/>');
                        //$('#message-box').append('Doubles!<br/>');
                        doublesRollNum+=1;

                    });

                    socket.on(`look for dice${game}`, function(rtnData){
                        //doublesRollNum might need to be controlled elsewhere                        
                        console.log('socket.on(look for dice)');
                        //this is lazy but it might work
                        if (doublesRollNum === 0){
                            //render dice
                            doublesRollNum = rtnData.doublesRollNum;
                        }
                        console.log(rtnData);
                        console.log(rtnData.data.rtnRoll);
                        console.log(doublesRollNum);
                        $('.die-label').remove();
                        if (doublesRollNum % 2 === 1){
                            // if distributed by current player
                            for (let i=0; i<rtnData.data.locs.length; i++){
                                console.log(i);
                                console.log(`${rtnData.data.locs[i]}`);
                                console.log(`#die${i+1}`);
                                
                                $(`${rtnData.data.locs[i]}`).append($(`#die${i+1}`)); 
                                $(`#die${i+1}`).css('position', '');
                                $(`#die${i+1}`).css('left', '');
                                $(`#die${i+1}`).css('top', '');
                            }
                        } else {
                            ;
                        }

                        if ($(`#${socket.id}-box`).children().length > 0){
                            $('#doubles-roll-btn').show(); 
                        }

                    });

                    $('#doubles-roll-btn').click(() => {
                        console.log('#doubles-roll-btn.click()');
                            $('#doubles-roll-btn').hide();
                            let doublesDice = new Dice($(`#${socket.id}-box`).children().length,6);
                            console.log($(`#${socket.id}-box`).children().length);
                            console.log($(`#${socket.id}-box`).children());
                            let ids = [];
                            let box = $(`#${socket.id}-box`).children();
                            
                            for (let i = 0; i<box.length; i++){
                                console.log(box[i].id);
                                ids.push(box[i].id);
                            }
                            
                            console.log(ids);

                            let roll = doublesDice.roll();
                            //let roll = [3,3];
                            console.log(roll);
                            
                            if (doublesRollNum % 2 === 0) {
                                console.log('original player re-roll');
                                socket.binary(false).emit('dice returned roll', {roll: roll, gameID: game, name: [name]});
                                // for testing only
                                //socket.emit('dice returned roll', {roll: [3], gameID: game, name: name});
                                //socket.emit('dice returned roll', {roll: [3], gameID: game, name: name});
                            } else {
                                console.log('line 287 - another doubles roll');
                                socket.binary(false).emit('doubles roll', {roll: roll, gameID: game, name: [name], ids: ids});
                            }

                        });

                    socket.on(`doubles die rolled${game}`, function(roll){
                        console.log('socket.on(doubles die rolled)');
                        console.log(roll);

                        // if (roll.clearTable){
                        //     clearTable();
                        //     debugger;
                        // }
                        displayDoublesDice(roll.roll, roll.name, roll.ids);
                    });    

                    socket.on(`doubles roll finished${game}`, function(roll){
                        console.log('socket.on(doubles roll finished)');
                        console.log(roll);
                        showMessage('clear');
                        //$('#message-box').text(' ');
                        //clearTable();
                        //displayDice(roll.roll, roll.names);

                        if (roll.roll[0] === roll.roll[1]){  // also change this if more dice can be used
                            // current player rolls again - if doubles again, 
                            
                            console.log(roll.roll);
                            //console.log(roll.roll[1]);
                            console.log(players.currentPlayer.id);
                            console.log(roll);
                            console.log(roll.rtnRoll);
                            console.log(doublesRollNum);
                            if (doublesRollNum % 2 === 0){
                                console.log('safe!');
                                if (players.currentPlayer.id == socket.id){
                                    $('.die').draggable("option", "disabled", false);
                                    $('#doubles-roll-btn').hide();
                                }

                            } else {
                                setTimeout(function(){//place dice back in current player box 
                                    $(`#${players.currentPlayer.id}-box`).append($(`#die1`)); 
                                    $(`#${players.currentPlayer.id}-box`).append($(`#die2`)); 
                                    $('.die-label').remove();

                                    if(players.currentPlayer.id === socket.id){
                                        $('#doubles-roll-btn').show();
                                    }
                                }, 1500);
                            }
                            
                        } 
                        else {
                            console.log(cont);
                            showMessage('change', `Drink!`);
                            // $('#message-box').text(`Drink!`);
                            if(players.currentPlayer.id === socket.id){
                                //console.log('continue!');
                                $('#roll-btn').show();
                                doubles = false;
                            }
                        }

                        doublesRollNum += 1;

                    });

                    $(window).on('beforeunload', (event) => {
                        console.log("unloading2");
                        socket.binary(false).emit('remove player', {gameID: game, id: socket.id, code: code, removeID: 2});
                        socket.close();
                    });


                    $(document).on('mousedown', 'img', function(){
                        $('.die-label').remove();
                    });
    

                    function checkDice(roll) { 
                        console.log($('#table').offset());
                        if (dice.rollTotal === 7){
                            console.log(7);
                            // tell the server that someone has to drink
                            socket.binary(false).emit('ahead', {gameID: game});
                            cont += 1;
                        }

                        if (dice.rollTotal === 11){
                            console.log(11);
                            socket.binary(false).emit('behind', {gameID: game});
                            cont += 1;
                        }

                        if (dice.rollTotal === 3){
                            console.log(3);
                            socket.binary(false).emit('three man the hard way', {gameID: game, id: socket.id});
                            console.log('end of dice.rollTotal === 3');
                        }

                        if (roll.includes(3)){
                            console.log('3 on a die');
                            socket.binary(false).emit('three man', {gameID: game});
                            cont += 1;
                        }

                        // test for doubles - needs to change if more dice are allowed
                        if (roll[0] === roll[1]){
                            doubles=true;
                            cont += 1;
                            console.log('doubles');
                            socket.binary(false).emit('doubles', {gameID: game});
                            
                        }
                        
                        if (dice.rollTotal !== 7 & dice.rollTotal !== 11 & !roll.includes(3) & roll[0] !== roll[1]){
                            cont = 0;
                            $('#roll-btn').hide();
                        }

                        console.log(`cont: ${cont}`);
                    };


                    function showMessage(action, message){
                        if (action === 'change') {
                            $('#message-box').text(message);
                        } else if (action === 'add') {
                            $('#message-box').append(message);
                        } else if (action === 'clear') {
                            $('#message-box').text(``);
                        }
                        
                        console.log(dice);
                        console.log($('#message-box').height());
                        let messageHeight = $('#message-box').height();
                        dice.dice;
                        // move dice down
                        
                        for (let i = 1; i <= dice.dice; i++){
                            let currentTop = $(`#die${i}`).css('top');
                            console.log(currentTop);
                            currentTop = currentTop.replace("px", "");
                            //console.log(currentTop);
                            //$(`#die${i}`).css('top', `${currentTop + messageHeight}px`)
                        }
                    }
                }


            
            });



            function displayDice(dice, dicePositions, diceRotations, diceText){
                console.log('in displayDice()');
                console.log(dicePositions);
                console.log($('#table').offset());
                console.log(`table height: ${$('#table').height()}`);
                console.log(`table width: ${$('#table').width()}`);
                let tableHeight = $('#table').height();
                let tableWidth = $('#table').width();
                let tableMiddle = tableWidth / 2;
                console.log($('#die1').width());
                let tablePosition = $('#table').offset();

                let leftBounds = [,0,tableMiddle];
                console.log(leftBounds);
                console.log(leftBounds.length);

                let i = 1;
                console.log(dice);
                dice.forEach((die) => {
                    // compute random top value
                    // range (highest - lowest) * random value + top bound
                    // compute random left value
        
                    let dieWidthAdjustment = (document.documentElement.clientWidth/100) * 5;
                    let top = getRandomLoc(0, tableHeight - dieWidthAdjustment, dicePositions[0][i-1]);
                    let left = getRandomLoc(leftBounds[i], tableMiddle - dieWidthAdjustment, dicePositions[1][i-1]);
                    if (diceText){
                        console.log(`#die${i}`);
                        console.log(diceText);
                        console.log(`${diceText[i-1]}`);
                        //$(`#table`).append(`<p class="die-label">${diceText[i-1]}</p>`);
                        $('#table').append(`<p class="die-label" id="die-label${i}">${diceText[i-1]}</p><img src="./assets/${die}.png" class="die" id="die${i}">`);  
                    }


                    else {
                        $('#table').append(`<img src="./assets/${die}.png" class="die" id="die${i}">`);  
                    }
                    $(`#die${i}`).css('left', `${left}px`);
                    $(`#die${i}`).css('top', `${top}px`);
                    $(`#die${i}`).css('position', `absolute`);
                    $(`#die${i}`).css('transform', `rotate(${getRandomLoc(0,90,diceRotations[i-1])}deg)`);
                    $(`#die-label${i}`).css('left', `${left}px`);
                    $(`#die-label${i}`).css('top', `${top+$(`#die-label${i}`).height()}px`);
                    $(`#die-label${i}`).css('position', `absolute`);
                    $('.die').draggable({
                        revert: 'invalid',
                        cursorAt: {top: 0, left: 0},
                        disabled: true
                    });
                    
                    i = i+1;
                });

            }

            function displayDoublesDice(dice, dicePositions, diceRotations, diceText, ids){
                console.log('in displayDoublesDice()');
                console.log($('#table').offset());
                console.log(`table height: ${$('#table').height()}`);
                console.log(`table width: ${$('#table').width()}`);
                let tableHeight = $('#table').height();
                let tableWidth = $('#table').width();
                let tableMiddle = tableWidth / 2;
                console.log($('#die1').width());
                let tablePosition = $('#table').offset();

                let leftBounds = [,0,tableMiddle];
                console.log(leftBounds);
                console.log(leftBounds.length);

                console.log(`dice: ${dice} diceText: ${diceText} ids: ${ids}`);

               
                for (let i = 0; i < dice.length; i++){
                    let j = ($('#table').children().length/2);

                    console.log(ids[i]);
                    console.log(diceText[i]);
                    $(`#${ids[i]}`).remove();
                    $('#table').append(`<p class="die-label" id="die-label${j}">${diceText[i]}</p><img src="./assets/${dice[i]}.png" class="die" id="${ids[i]}">`);  
                
                    
                    let dieWidthAdjustment = (document.documentElement.clientWidth/100) * 5;
                    let top = getRandomLoc(0, tableHeight - dieWidthAdjustment, dicePositions[0][i]);
                    console.log(j);
                    console.log(`${leftBounds[j+1]}`);
                    console.log(`${tableMiddle}`);
                    let left = getRandomLoc(leftBounds[j+1], tableMiddle - dieWidthAdjustment, dicePositions[1][i]);
                
                    $(`#${ids[i]}`).css('left', `${left}px`);
                    $(`#${ids[i]}`).css('top', `${top}px`);
                    $(`#${ids[i]}`).css('position', `absolute`);
                    $(`#${ids[i]}`).css('transform', `rotate(${getRandomLoc(0,90,diceRotations[i])}deg)`);
                    $(`#die-label${j}`).css('left', `${left}px`);
                    $(`#die-label${j}`).css('top', `${top+$(`#die-label${j}`).height()}px`);
                    $(`#die-label${j}`).css('position', `absolute`);
                
                }
                    
            }

            function getRandomLoc(leftOrTopBound, rangeSize, randNum){
                    //let rand = Math.random();
                    let rand = randNum;
                    rand = rand*rangeSize;
                    console.log(leftOrTopBound + rand);
                    return leftOrTopBound + rand;
            }

            function clearTable(){
                $('.die').remove();
                $('.die-label').remove();
            }

        </script>
    </head>

    <body>
        <h1>3 Man!</h1>
        <div class="flex-container">
            
            <input type="text" placeholder="Name" id="name">
            <input type="number" placeholder="Table code (if joining)" id="code">
            <br/>
            <button id="start">Start new game</button>
            <button id="join">Join existing game</button>

        </div>
        
    </body>

</html>