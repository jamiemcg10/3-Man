<!DOCTYPE html>
<html lang="en">
    <head>
        <title></title>
        <meta charset="utf-8">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="/static/classes.js"></script>
        <script>
            var socket = io({reconnection: false});
            var id = socket.id;
            let inWaitingRoom = false;
            let game;
            let code;

            $(document).ready(() => {

                //let game;
                let name;
                let playersInGame = null;

                $('#start').click(() => {
                    id = socket.id;
                    name = $('#name').val();
                    $('div').remove();
                    socket.emit('get code', socket.id);
                    console.log(socket.id);
                    console.log(id);
                    console.log(`code${id}`);
                });

                socket.on('game code', function(data){
                    // $('body').append(`<div class="code">${data.code}</div>`);
                    // $('body').append('<div class="player-pool"></div>');
                    if (data.id === id){
                        console.log(data);
                        //let code = data.code;
                        code = data.code;
                        //let game = String(code)[0];
                        game = String(code)[0];
                        console.log(code);
                        console.log(data.code);

                        // enter waiting room here - need to continue to display code somehow
                        socket.emit('add to waiting room', {code: data.code, gameID: game, id: id, name: name, locationDELETE: 'onGameCode'});
                        inWaitingRoom = true;
                        
                        displayRoom(game);

                    }
                    
                });



                $('#join').click(() => {
                    id = socket.id;
                    //let code = $('#code').val();
                    code = $('#code').val();
                    game = String(code)[0];
                    name = $('#name').val();
                    console.log(code);
                    socket.emit('validate code', {code: code, requestingID: id});
    

                    socket.on(`validated code${code}`, function(code){
                        console.log(code);
                        if (code.valid & code.requestingID === id){
                            console.log('code is valid');
                            $('div').remove();
                            // $('body').append(`<div class="code">${code.code}</div>`);
                            // $('body').append('<div class="player-pool"></div>');
                            socket.emit('add to waiting room', {code: code, gameID: game, id: id, name: name, locationDELETE: 'onValidatedCode'});
                            inWaitingRoom = true;
                            console.log(game);
                            displayRoom(game);
                        }
                        else {
                            $('body').append('<div class="warning">The code you entered is invalid</div>')

                        }

                    });
                });



            
                function displayRoom(roomNo){
                    console.log('in displayRoom(roomNo)');
                    $('body').append(`<div class="code">${code}</div>`);
                    $('body').append('<div class="player-pool"></div>');
                    $('body').append('<button>Start game</button>');

                    socket.on(`state${roomNo}`, function(data){
                        console.log(data);
                        if (inWaitingRoom){
                            // display players

                            // update player pool view
                            currentGame = new Game(data); 
                            let players = PlayerPool.PlayerPool(currentGame);

                            
                            //console.log(players);
                            if (!players.equals(playersInGame)){
                                console.log('not equal');
                                $('.player-pool').html("");
                                console.log(players.list);
                                players.list.forEach((player) => {
                                    console.log('in forEach');
                                    $('.player-pool').append(`<div id="${player.__id}-container"><div class="player" id="${player.__id}">${player.__name}</div><div class="dice-box" id="${player.__id}-box"></div></div>`);
                                });

                            }
                            
                            playersInGame = players;

                        }
                    });


                    // leave the game on disconnect
                    $(window).on('unload', (event) => {
                        socket.emit('remove player', {gameID: roomNo, id: socket.id});
                        socket.close();
                    });
                    //return null;
                }

            });



        </script>
    </head>

    <body>
        <div><input type="text" placeholder="Name" id="name"></div>
        <div>
            <button id="start">Start game</button>
        </div>
        <div>
            <input type="number" placeholder="Table code" id="code">
            <button id="join">Join game</button>
        </div>
        
    </body>

</html>